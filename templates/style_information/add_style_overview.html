{% extends 'style_information/base.html' %}
{% block title %}Summary of Style Information{% endblock %}

{% block content %}
<div class="mt-2 mb-1 w-full px-1">
    <h1 class="text-2xl text-green-500 font-bold mb-6 text-center">
        Add Style Overview
    </h1>
    <div class="overflow-x-auto">
        <table class="min-w-full table-auto border border-black text-sm w-full mb-[100px]">
            <thead class="bg-gray-300">
                <tr class="border p-1 text-center">
                    <th class="border p-1 relative">
                        Customer
                        <span class="dropdown-icon cursor-pointer ml-2 text-blue-500">
                            <i class="fa-regular fa-square-caret-down"></i>
                        </span>
                        <input type="text" class="filter-input absolute top-full left-0 hidden border p-1 w-full" placeholder="Search...">
                    </th>

                    <th class="border p-1 relative">
                        Style
                        <span class="dropdown-icon cursor-pointer ml-2 text-blue-500">
                            <i class="fa-regular fa-square-caret-down"></i>
                        </span>
                        <input type="text" class="filter-input absolute top-full left-0 hidden border p-1 w-full" placeholder="Search...">
                    </th>

                    <th class="border p-1">Season</th>
                    <th class="border p-1">Production Line</th>
                    <th class="border p-1">APM</th>
                    <th class="border p-1">Technician</th>
                    <th class="border p-1">QC</th>
                    <th class="border p-1">QA</th>
                    <th class="border p-1">TQS</th>
                    <th class="border p-1 w-[50px]">Action</th>
                </tr>
            </thead>
            <tbody>
                {% if customers %}
                    {% for cust in customers %}
                        {% for item in cust.styles %}
                            {% for row in item.rows %}
                                <tr data-customer="{{ cust.customer }}" data-style="{{ item.style_no }}" data-group="{{ cust.customer }}||{{ item.style_no }}">
                                    {% if forloop.first and forloop.parentloop.first %}
                                        <td class="border p-1" rowspan="{{ cust.rowspan }}">{{ cust.customer }}</td>
                                    {% endif %}
                                    {% if forloop.first %}
                                        <td class="border px-2 py-1 relative" rowspan="{{ item.rowspan }}">
                                            <div class="style-cell cursor-pointer text-blue-600 relative" data-style="{{ item.style_no }}">
                                                {{ item.style_no }}
                                                <span class="search-icon ml-2 text-yellow-500">
                                                    <i class="fa-solid fa-folder-tree"></i>
                                                </span>
                                                <div class="style-dropdown hidden absolute left-0 top-[100%] bg-black text-white border shadow-md min-w-[250px] z-[9999] max-h-[200px] overflow-y-auto">
                                                    <input type="text" placeholder="Search description..." class="desc-search text-black border p-1 w-full mb-1">
                                                    {% if item.descriptions %}
                                                        {% for desc in item.descriptions %}
                                                            <div class="dropdown-item px-2 py-1 hover:bg-gray-200 cursor-pointer" data-url="{% url 'style_detail' desc.style.id %}">
                                                                {{ desc.style_description }}
                                                            </div>
                                                        {% endfor %}
                                                    {% else %}
                                                        <div class="px-2 py-1 text-gray-400">No description</div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </td>
                                    {% endif %}
                                    <td class="border p-1">{{ row.season }}</td>
                                    <td class="border p-1">{{ row.production_line }}</td>
                                    <td class="border p-1">{{ row.apm }}</td>
                                    <td class="border p-1">{{ row.technician }}</td>
                                    <td class="border p-1">{{ row.qc }}</td>
                                    <td class="border p-1">{{ row.qa }}</td>
                                    <td class="border p-1">{{ row.tqs }}</td>
                                    <td class="border p-1">
                                        <div class="flex justify-between">
                                            <a href="#" class="bg-yellow-500 text-white px-2 py-1 mr-1 rounded">
                                                <i class="fa-regular fa-pen-to-square"></i>
                                            </a>
                                            <a href="{% url 'delete_add_style_overview' row.id %}" class="bg-red-600 text-white px-2 py-1 mr-1 rounded"
                                            onclick="return confirm('Are you sure you want to delete this entry?');">
                                                <i class="fa-solid fa-trash-can"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        {% endfor %}
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="10" class="border p-2 text-center text-red-600 font-bold">
                            No data available
                        </td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const table = document.querySelector("table");
    const tbody = table.querySelector("tbody");

    const customerMap = new Map();
    const styleMap = new Map();
    const groups = {};

    (function buildInitialMaps(){
        const rows = Array.from(tbody.querySelectorAll("tr"));
        rows.forEach(row => {
            const cust = row.dataset.customer;
            const style = row.dataset.style;
            const groupKey = row.dataset.group;

            if (!groups[groupKey]) groups[groupKey] = [];
            groups[groupKey].push(row);

            const rowspanTds = Array.from(row.querySelectorAll("td[rowspan]"));
            if (rowspanTds.length) {
                const custTd = rowspanTds.find(td => !td.querySelector('.style-cell'));
                const styleTd = rowspanTds.find(td => td.querySelector('.style-cell'));
                if (custTd && cust && !customerMap.has(cust)) {
                    customerMap.set(cust, { td: custTd, originalRow: row });
                }
                if (styleTd && groupKey && !styleMap.has(groupKey)) {
                    styleMap.set(groupKey, { td: styleTd, originalRow: row });
                }
            }
        });
    })();
    // --- dropdown logic ---
    let active = { clone: null, originalParent: null, nextSibling: null };
    function closeActive() {
        if (!active.clone) return;
        active.clone.remove();
        active = { clone: null, originalParent: null, nextSibling: null };
    }
    function showDropdown(cell, originalDropdown) {
        closeActive();
        const clone = originalDropdown.cloneNode(true);
        clone.classList.remove('hidden');
        clone.style.position = 'absolute';
        clone.style.zIndex = '9999';
        clone.style.maxHeight = '200px';
        clone.style.overflowY = 'auto';
        document.body.appendChild(clone);
        const rect = cell.getBoundingClientRect();
        clone.style.left = (rect.left + window.scrollX) + 'px';
        clone.style.top = (rect.bottom + window.scrollY) + 'px';
        clone.style.minWidth = Math.max(cell.offsetWidth, 250) + 'px';

        const searchInput = clone.querySelector('.desc-search');
        if (searchInput) {
            searchInput.addEventListener('input', function () {
                const filter = this.value.toLowerCase();
                const items = clone.querySelectorAll('.dropdown-item');
                items.forEach(item => item.style.display = item.innerText.toLowerCase().includes(filter) ? '' : 'none');
            });
        }

        active.clone = clone;
    }

    document.querySelectorAll('.style-cell').forEach(cell => {
        cell.addEventListener('click', function (e) {
            e.stopPropagation();
            const dropdown = cell.querySelector('.style-dropdown');
            if (!dropdown) return;
            if (active.clone) { closeActive(); return; }
            showDropdown(cell, dropdown);
        });
    });
    document.addEventListener('click', function(e) {
        if (active.clone && active.clone.contains(e.target)) return;
        closeActive();
    });
    // --- filtering logic ---
    function filterTable() {
        const inputs = Array.from(document.querySelectorAll("thead .filter-input"));
        const filters = inputs.map(i => i.value.toLowerCase().trim());

        const visibleGroupKeys = new Set();
        for (const [groupKey, rows] of Object.entries(groups)) {
            const [cust, style] = groupKey.split('||');

            let ok = true;
            for (let idx = 0; idx < filters.length; idx++) {
                const filter = filters[idx];
                if (!filter) continue;

                let colMatch = false;
                if (idx === 0) { 
                    if (cust && cust.toLowerCase().includes(filter)) colMatch = true;
                } else if (idx === 1) {
                    if (style && style.toLowerCase().includes(filter)) colMatch = true;
                } else {
                    // (not used now) 
                }

                if (!colMatch) { ok = false; break; }
            }

            if (ok) visibleGroupKeys.add(groupKey);
        }

        for (const [groupKey, rows] of Object.entries(groups)) {
            const show = visibleGroupKeys.has(groupKey);
            rows.forEach(r => r.style.display = show ? "" : "none");
        }

        const customerVisibleRows = new Map();
        for (const [groupKey, rows] of Object.entries(groups)) {
            const [cust] = groupKey.split('||');
            rows.forEach(r => {
                if (r.style.display !== 'none') {
                    if (!customerVisibleRows.has(cust)) customerVisibleRows.set(cust, []);
                    customerVisibleRows.get(cust).push(r);
                }
            });
        }

        for (const [cust, info] of customerMap.entries()) {
            const custTd = info.td;
            const visibleRows = customerVisibleRows.get(cust) || [];
            if (visibleRows.length === 0) {
                custTd.style.display = 'none';
            } else {
                custTd.style.display = '';
                custTd.rowSpan = visibleRows.length;
                const firstRow = visibleRows[0];
                firstRow.insertBefore(custTd, firstRow.firstElementChild || null);
            }
        }

        for (const [groupKey, info] of styleMap.entries()) {
            const styleTd = info.td;
            const rows = groups[groupKey] || [];
            const visibleRows = rows.filter(r => r.style.display !== 'none');
            if (visibleRows.length === 0) {
                styleTd.style.display = 'none';
            } else {
                styleTd.style.display = '';
                styleTd.rowSpan = visibleRows.length;
                const firstRow = visibleRows[0];
                const ref = firstRow.children[1] || null;
                firstRow.insertBefore(styleTd, ref);
            }
        }
    }

    const dropdownIcons = document.querySelectorAll(".dropdown-icon");
    dropdownIcons.forEach(icon => {
        icon.addEventListener("click", function (e) {
            e.stopPropagation();
            const input = icon.parentNode.querySelector(".filter-input");
            if (!input) return;
            input.classList.toggle("hidden");
            if (!input.classList.contains("hidden")) input.focus();
            if (input.classList.contains("hidden")) filterTable();
        });
    });

    document.querySelectorAll(".filter-input").forEach(input => {
        input.addEventListener("keyup", filterTable);
    });

    document.body.addEventListener('click', function(e) {
        const item = e.target.closest('.dropdown-item');
        if (!item) return;
        const url = item.getAttribute('data-url');
        if (url) window.location.href = url;
    });

    filterTable();
});
</script>
{% endblock %}
