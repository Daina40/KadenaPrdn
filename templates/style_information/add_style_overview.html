{% extends 'style_information/base.html' %}
{% block title %}Summary of Style Information{% endblock %}

{% block content %}
<div class="mt-2 mb-1 w-full px-1">
    <h1 class="text-2xl text-green-500 font-bold mb-6 text-center">
        Add Style Overview
    </h1>
    <div class="overflow-x-auto">
        <table class="min-w-full table-auto border border-black text-sm w-full mb-[100px]">
            <thead class="bg-gray-300">
                <tr class="border p-1 text-center">
                    <th class="border p-1 relative">
                        Customer
                        <span class="dropdown-icon cursor-pointer ml-2 text-blue-500">
                            <i class="fa-regular fa-square-caret-down"></i>
                        </span>
                        <input type="text" class="filter-input absolute top-full left-0 hidden border p-1 w-full" placeholder="Search...">
                    </th>

                    <th class="border p-1 relative">
                        Style
                        <span class="dropdown-icon cursor-pointer ml-2 text-blue-500">
                            <i class="fa-regular fa-square-caret-down"></i>
                        </span>
                        <input type="text" class="filter-input absolute top-full left-0 hidden border p-1 w-full" placeholder="Search...">
                    </th>

                    <th class="border p-1">Season</th>
                    <th class="border p-1">Production Line</th>
                    <th class="border p-1">APM</th>
                    <th class="border p-1">Technician</th>
                    <th class="border p-1">QC</th>
                    <th class="border p-1">QA</th>
                    <th class="border p-1">TQS</th>
                    <th class="border p-1 w-[50px]">Action</th>
                </tr>
            </thead>
            <tbody>
                {% if customers %}
                    {% for cust in customers %}
                        {% for item in cust.styles %}
                            {% for row in item.rows %}
                                <tr>
                                    {% if forloop.first and forloop.parentloop.first %}
                                        <td class="border p-1" rowspan="{{ cust.rowspan }}">{{ cust.customer }}</td>
                                    {% endif %}
                                    {% if forloop.first %}
                                        <td class="border px-2 py-1 relative" rowspan="{{ item.rowspan }}">
                                            <div class="style-cell cursor-pointer text-blue-600 relative">
                                                {{ item.style_no }}
                                                <span class="search-icon ml-2 text-yellow-500">
                                                    <i class="fa-solid fa-folder-tree"></i>
                                                </span>
                                                <div class="style-dropdown hidden absolute left-0 top-[100%] bg-black text-white border shadow-md min-w-[250px] z-[9999] max-h-[200px] overflow-y-auto">
                                                    <input type="text" placeholder="Search description..." class="desc-search text-black border p-1 w-full mb-1">
                                                    {% if item.descriptions %}
                                                        {% for desc in item.descriptions %}
                                                            <div class="dropdown-item px-2 py-1 hover:bg-gray-200 cursor-pointer" data-url="{% url 'style_detail' desc.id %}">
                                                                {{ desc.style_description }}
                                                            </div>
                                                        {% endfor %}
                                                    {% else %}
                                                        <div class="px-2 py-1 text-gray-400">No description</div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </td>
                                    {% endif %}
                                    <td class="border p-1">{{ row.season }}</td>
                                    <td class="border p-1">{{ row.production_line }}</td>
                                    <td class="border p-1">{{ row.apm }}</td>
                                    <td class="border p-1">{{ row.technician }}</td>
                                    <td class="border p-1">{{ row.qc }}</td>
                                    <td class="border p-1">{{ row.qa }}</td>
                                    <td class="border p-1">{{ row.tqs }}</td>
                                    <td class="border p-1">
                                        <div class="flex justify-between">
                                            <a href="#" class="bg-yellow-500 text-white px-2 py-1 mr-1 rounded">
                                                <i class="fa-regular fa-pen-to-square"></i>
                                            </a>
                                            <a href="{% url 'delete_add_style_overview' row.id %}" class="bg-red-600 text-white px-2 py-1 mr-1 rounded"
                                            onclick="return confirm('Are you sure you want to delete this entry?');">
                                                <i class="fa-solid fa-trash-can"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        {% endfor %}
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="10" class="border p-2 text-center text-red-600 font-bold">
                            No data available
                        </td>
                    </tr>
                {% endif %}
            </tbody>

        </table>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const table = document.querySelector("table");

    // --- Dropdown logic ---
    let active = { el: null, parent: null, nextSibling: null };
    function closeActive() {
        if (!active.el) return;
        active.el.classList.add('hidden');
        if (active.parent) active.parent.insertBefore(active.el, active.nextSibling || null);
        active = { el: null, parent: null, nextSibling: null };
    }
    function showDropdown(cell, dropdown) {
        closeActive();
        active.parent = dropdown.parentNode;
        active.nextSibling = dropdown.nextElementSibling;
        active.el = dropdown;
        document.body.appendChild(dropdown);
        dropdown.classList.remove('hidden');
        dropdown.style.position = 'absolute';
        dropdown.style.zIndex = '9999';
        dropdown.style.maxHeight = '200px';
        dropdown.style.overflowY = 'auto';
        const rect = cell.getBoundingClientRect();
        dropdown.style.minWidth = Math.max(cell.offsetWidth, 250) + 'px';
        dropdown.style.left = rect.left + window.scrollX + 'px';
        dropdown.style.top = rect.bottom + window.scrollY + 'px';

        const searchInput = dropdown.querySelector('.desc-search');
        if (searchInput && !searchInput.dataset.bound) {
            searchInput.dataset.bound = '1';
            searchInput.addEventListener('input', function () {
                const filter = this.value.toLowerCase();
                const items = dropdown.querySelectorAll('.dropdown-item');
                items.forEach(item => {
                    item.style.display = item.innerText.toLowerCase().includes(filter) ? '' : 'none';
                });
            });
        }
    }
    document.querySelectorAll('.style-cell').forEach(cell => {
        cell.addEventListener('click', function (e) {
            e.stopPropagation();
            const dropdown = cell.querySelector('.style-dropdown');
            if (!dropdown) return;
            if (active.el === dropdown) { closeActive(); return; }
            showDropdown(cell, dropdown);
        });
    });
    document.addEventListener('click', e => { if (active.el && !active.el.contains(e.target)) closeActive(); });

    // --- Filter function ---
    function filterTable() {
        const rows = Array.from(table.querySelectorAll("tbody tr"));
        const groups = {};
        rows.forEach(row => {
            const key = row.getAttribute("data-group");
            if (!groups[key]) groups[key] = [];
            groups[key].push(row);
        });

        const inputs = Array.from(document.querySelectorAll("thead .filter-input"));
        const filters = inputs.map(input => input.value.toLowerCase().trim());

        Object.values(groups).forEach(groupRows => {
            let groupMatch = true;
            filters.forEach((filter, colIdx) => {
                if (!filter) return;
                let colMatch = false;
                groupRows.forEach((row, idx) => {
                    let cellText = "";
                    if (colIdx === 0) {
                        const customerCell = row.querySelector("td[rowspan]");
                        if (customerCell) cellText = customerCell.innerText.toLowerCase().trim();
                    } else if (colIdx === 1) {
                        const styleCell = groupRows[0].querySelector(".style-cell");
                        if (styleCell) cellText = styleCell.innerText.toLowerCase().trim();
                    } else {
                        const offset = colIdx - 2;
                        const normalCells = row.querySelectorAll("td:not([rowspan])");
                        if (normalCells[offset]) cellText = normalCells[offset].innerText.toLowerCase().trim();
                    }
                    if (cellText.includes(filter)) colMatch = true;
                });
                if (!colMatch) groupMatch = false;
            });

            groupRows.forEach((row, idx) => {
                row.style.display = groupMatch ? "" : "none";
                row.querySelectorAll("[rowspan]").forEach(cell => {
                    cell.style.display = (idx === 0 && groupMatch) ? "" : "none";
                });
            });
        });
    }

    // --- Toggle filter inputs on icon click ---
    const dropdownIcons = document.querySelectorAll(".dropdown-icon");
    dropdownIcons.forEach(icon => {
        icon.addEventListener("click", function(e) {
            e.stopPropagation();
            const input = icon.parentNode.querySelector(".filter-input");
            if (!input) return;
            input.classList.toggle("hidden");
            if (!input.classList.contains("hidden")) input.focus();
        });
    });

    // --- Attach keyup to all filter inputs ---
    document.querySelectorAll('.filter-input').forEach(input => {
        input.addEventListener('keyup', filterTable);
    });

    // --- Handle style description clicks ---
    document.body.addEventListener('click', function(e) {
        const item = e.target.closest('.dropdown-item');
        if (!item) return;
        const url = item.getAttribute('data-url');
        if (url) window.location.href = url;
    });
});
</script>
{% endblock %}
