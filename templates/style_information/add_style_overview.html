{% extends 'style_information/base.html' %}
{% block title %}Summary of Style Information{% endblock %}

{% block content %}
<div class="mt-2 mb-1 w-full px-1">
    <h1 class="text-2xl text-green-500 font-bold mb-6 text-center">
        Add Style Overview
    </h1>
    <div class="overflow-x-auto">
        <table class="min-w-full table-auto border border-black text-sm w-full text-center">
            <thead class="bg-gray-200">
                <tr>
                    <th class="border p-1">
                        Customer
                        <span class="dropdown-icon cursor-pointer ml-2 text-blue-500">
                            <i class="fa-regular fa-square-caret-down"></i>
                        </span>
                    </th>
                    
                    <th class="border p-1">
                        Style
                        <span class="dropdown-icon cursor-pointer ml-2 text-blue-500">
                            <i class="fa-regular fa-square-caret-down"></i>
                        </span>
                    </th>

                    <th class="border p-1">
                        Season
                        <span class="dropdown-icon cursor-pointer ml-2 text-blue-500">
                            <i class="fa-regular fa-square-caret-down"></i>
                        </span>
                    </th>

                    <th class="border p-1">Production Line
                        <span class="dropdown-icon cursor-pointer ml-2 text-blue-500">
                            <i class="fa-regular fa-square-caret-down"></i>
                        </span>
                    </th>
                    <th class="border p-1">APM
                        <span class="dropdown-icon cursor-pointer ml-2 text-blue-500">
                            <i class="fa-regular fa-square-caret-down"></i>
                        </span>
                    </th>
                    <th class="border p-1">Technician
                        <span class="dropdown-icon cursor-pointer ml-2 text-blue-500">
                            <i class="fa-regular fa-square-caret-down"></i>
                        </span>
                    </th>
                    <th class="border p-1">QC
                        <span class="dropdown-icon cursor-pointer ml-2 text-blue-500">
                            <i class="fa-regular fa-square-caret-down"></i>
                        </span>
                    </th>
                    <th class="border p-1">QA
                        <span class="dropdown-icon cursor-pointer ml-2 text-blue-500">
                            <i class="fa-regular fa-square-caret-down"></i>
                        </span>
                    </th>
                    <th class="border p-1">TQS
                        <span class="dropdown-icon cursor-pointer ml-2 text-blue-500">
                            <i class="fa-regular fa-square-caret-down"></i>
                        </span>
                    </th>
                    <th class="border p-1 w-[50px]">Action</th>
                </tr>
            </thead>
            <tbody>
                {% if styles %}
                    {% for item in styles %}
                        {% for row in item.rows %}
                            <tr>
                                {% if forloop.first %}
                                    <!-- Customer (merged) -->
                                    <td class="border p-1" rowspan="{{ item.rowspan }}">{{ item.customer }}</td>

                                    <!-- Style (merged with dropdown) -->
                                    <td class="border px-2 py-1 relative" rowspan="{{ item.rowspan }}">
                                        <div class="style-cell cursor-pointer text-blue-600 relative">
                                            {{ item.style_no }}
                                            <span class="search-icon ml-2 text-yellow-500">
                                                <i class="fa-solid fa-folder-tree"></i>
                                            </span>
                                            <div class="style-dropdown hidden absolute left-0 top-[100%] bg-black text-white border shadow-md min-w-[250px] z-[9999] max-h-[200px] overflow-y-auto">
                                                <input type="text" placeholder="Search description..." class="desc-search text-black border p-1 w-full mb-1">
                                                {% if item.descriptions %}
                                                    {% for desc in item.descriptions %}
                                                        <div class="dropdown-item px-2 py-1 hover:bg-gray-200 cursor-pointer" data-url="{% url 'style_detail' desc.id %}">
                                                            {{ desc.style_description }}
                                                        </div>
                                                    {% endfor %}
                                                {% else %}
                                                    <div class="px-2 py-1 text-gray-400">No description</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </td>
                                {% endif %}

                                <!-- The varying fields (per row) -->
                                <td class="border p-1">{{ row.season }}</td>
                                <td class="border p-1">{{ row.production_line }}</td>
                                <td class="border p-1">{{ row.apm }}</td>
                                <td class="border p-1">{{ row.technician }}</td>
                                <td class="border p-1">{{ row.qc }}</td>
                                <td class="border p-1">{{ row.qa }}</td>
                                <td class="border p-1">{{ row.tqs }}</td>
                                <td class="border p-1">
                                    <div class="flex justify-between">
                                        <a href="#" class="bg-yellow-500 text-white px-2 py-1 mr-1 rounded">
                                            <i class="fa-regular fa-pen-to-square"></i>
                                        </a>
                                        <a href="{% url 'delete_add_style_overview' row.id %}" class="bg-red-600 text-white px-2 py-1 rounded"
                                        onclick="return confirm('Are you sure you want to delete this entry?');">
                                            <i class="fa-solid fa-trash-can"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="10" class="border p-2 text-center text-red-600 font-bold">
                            No data available
                        </td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const table = document.querySelector("table");

        // track active dropdown so we can restore it later
        let active = { el: null, parent: null, nextSibling: null };

        function closeActive() {
            if (!active.el) return;
            // hide & reset styles
            active.el.classList.add('hidden');
            active.el.style.position = '';
            active.el.style.left = '';
            active.el.style.top = '';
            active.el.style.minWidth = '';
            active.el.style.maxHeight = '';
            active.el.style.overflowY = '';
            active.el.style.boxSizing = '';
            active.el.style.zIndex = '';
            active.el.style.visibility = '';

            // move back to original place
            if (active.parent) {
            active.parent.insertBefore(active.el, active.nextSibling || null);
            }
            active = { el: null, parent: null, nextSibling: null };
        }

        function showDropdown(cell, dropdown) {
            // close other
            closeActive();

            // save original location
            active.parent = dropdown.parentNode;
            active.nextSibling = dropdown.nextElementSibling;
            active.el = dropdown;

            // move dropdown to body (so it won't affect table layout)
            document.body.appendChild(dropdown);

            // prepare styles
            dropdown.classList.remove('hidden');
            dropdown.style.position = 'absolute';
            dropdown.style.boxSizing = 'border-box';
            dropdown.style.visibility = 'hidden'; // hide while we measure/position
            dropdown.style.maxHeight = '200px';
            dropdown.style.overflowY = 'auto';
            dropdown.style.zIndex = '9999';

            // calculate width (keep it within viewport)
            const rect = cell.getBoundingClientRect();
            const desiredWidth = Math.max(cell.offsetWidth, 250);
            const maxAllowed = window.innerWidth - 20; // 10px padding each side
            const width = Math.min(desiredWidth, maxAllowed);
            dropdown.style.minWidth = width + 'px';

            // force reflow to ensure offsetHeight is available
            void dropdown.offsetHeight;

            // calculate left (keep inside viewport)
            let left = rect.left + window.scrollX;
            if (left + width > window.scrollX + window.innerWidth - 10) {
            left = window.scrollX + window.innerWidth - width - 10;
            }
            if (left < window.scrollX + 10) left = window.scrollX + 10;

            // compute vertical position (open below or above if not enough space)
            const spaceBelow = window.innerHeight - rect.bottom;
            const maxH = 200; // same as maxHeight
            let top;
            if (spaceBelow < maxH + 10 && rect.top > maxH + 10) {
            // open above the cell
            top = rect.top + window.scrollY - Math.min(dropdown.offsetHeight || maxH, maxH);
            } else {
            // open below
            top = rect.bottom + window.scrollY;
            }

            dropdown.style.left = left + 'px';
            dropdown.style.top = top + 'px';
            dropdown.style.visibility = ''; // now visible

            // bind description search only once per element
            const searchInput = dropdown.querySelector('.desc-search');
            if (searchInput && !searchInput.dataset.bound) {
            searchInput.dataset.bound = '1';
            searchInput.addEventListener('input', function () {
                const filter = this.value.toLowerCase();
                const items = dropdown.querySelectorAll('.dropdown-item');
                items.forEach(item => {
                item.style.display = item.innerText.toLowerCase().includes(filter) ? '' : 'none';
                });
            });
            }
        }

        // attach click to style cells
        document.querySelectorAll('.style-cell').forEach(cell => {
            cell.addEventListener('click', function (e) {
            e.stopPropagation();
            const dropdown = cell.querySelector('.style-dropdown');
            if (!dropdown) return;
            // toggle if same
            if (active.el === dropdown) {
                closeActive();
                return;
            }
            showDropdown(cell, dropdown);
            });
        });

        // close on outside click, restore dropdown into table
        document.addEventListener('click', function (e) {
            // allow clicks inside active dropdown
            if (active.el && active.el.contains(e.target)) return;
            closeActive();
        });

        // close on scroll/resize so position doesn't get stale
        window.addEventListener('scroll', () => { if (active.el) closeActive(); });
        window.addEventListener('resize', () => { if (active.el) closeActive(); });

        // --- Column filter dropdown code (same as before) ---
        const dropdownIcons = document.querySelectorAll(".dropdown-icon");
        dropdownIcons.forEach((icon, colIndex) => {
            icon.addEventListener("click", function (event) {
            event.stopPropagation();

            let existingInput = icon.parentNode.querySelector("input");
            if (existingInput) {
                existingInput.remove();
                return;
            }

            let input = document.createElement("input");
            input.type = "text";
            input.placeholder = "Search...";
            input.classList.add("border", "p-1", "mt-1", "w-full");

            icon.parentNode.appendChild(input);

            input.addEventListener("keyup", function () {
                let filter = input.value.toLowerCase();
                let rows = table.querySelectorAll("tbody tr");

                rows.forEach(row => {
                // note: rows include both style rows and (if any) expanded rows, so ensure you target only main rows if you add extra rows
                let cellText = row.cells[colIndex]?.innerText?.toLowerCase() || "";
                row.style.display = cellText.includes(filter) ? "" : "none";
                });
            });
            });
        });
        
        document.body.addEventListener('click', function(e) {
            const item = e.target.closest('.dropdown-item');
            if (!item) return;
            const url = item.getAttribute('data-url');
            if (url) window.location.href = url;
        });
    });
</script>


{% endblock %}
